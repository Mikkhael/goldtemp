<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="style.css"/>
    <script src="wswrapper.js"></script>
     
</head>
<body>
    <div class="bg"></div>
    <div class="tab">
        <div class="tabs" onclick="moveToHome()">
            <span style="font-weight: bold">Home</span>
        </div>
        <div class="tabs" onclick="moveToSettings()">
            <span style="font-weight: bold">Settings</span>
        </div>
        <div class="tabs" onclick="moveToGraph()">
            <span style="font-weight: bold">Graph</span>
        </div>
        <div class="tabs" onclick="moveToErrors()">
            <span style="font-weight: bold">Errors</span>
        </div>
    </div>
    <div class="move" id="index.html">
    <div class="temp" id="temp">
    </div>
    </div>

    <script type="text/javascript">
    function Sth(site, to_what){fetch(site)
        .then(function(response) {
            return response.text()
        })
        .then(function(html) {
            var parser = new DOMParser();
            var content = parser.parseFromString(html, "text/html");
            var div = content.querySelector(".move");
            div.style.display = "none";
            div.setAttribute("id", site);
            document.body.appendChild(div);
    })
    .catch(function(err) {  
        console.log('Failed to fetch page: ', err);  
    })};
        var ToSettings, ToGraph, ToErrors, ToHome;

        Sth('settings.html', 'ToSettings');
        Sth('graph.html', 'ToGraph');
        Sth('errors.html', 'ToErrors'); 

        window.onload = function(){ToHome = document};

        function disableAll(){
            document.getElementById("settings.html").style.display = "none";
            document.getElementById("graph.html").style.display = "none";
            document.getElementById("errors.html").style.display = "none";
            document.getElementById("index.html").style.display = "none";
        }

        function moveToSettings(){
            disableAll();
            document.getElementById("settings.html").style.display = "block";
        }

        function moveToGraph(){
            disableAll();
            document.getElementById("graph.html").style.display = "block";
        }

        function moveToErrors(){
            disableAll();
            document.getElementById("errors.html").style.display = "block";
        }

        function moveToHome(){
            disableAll();
            document.getElementById("index.html").style.display = "block";
        }

        function addElement(){
            var newDiv = document.createElement("div");
            newDiv.innerHTML = `<span class="TherName" style="font-weight: bold">"getThermometerNames()"</span>
            <br><br>
            <span class="Temp" style="font-weight: bold">"getLastTemperatures()"</span>
            <br><br>
            <span class="Times" style="font-weight: bold">Time:</span>`;
            return newDiv;
        }

        var a = document.getElementById("temp");

        var thermometers = {};

        let socket = new Socket();

        
        function reloadTemps(){
            document.getElementById('temp').innerHTML = "";
            
            for(let id in thermometers){
                let div = addElement();
                div.querySelector(".TherName").innerHTML = getDeviceNameById(thermometers[id].id);
                div.querySelector(".Temp").innerHTML = `${thermometers[id].value} ℃`;
                
                let fmt = new Intl.DateTimeFormat([], {dateStyle: "short", timeStyle: 'long'});
                let date = new Date(Number(thermometers[id].time));
                
                div.querySelector(".Times").innerHTML = `Time: ${fmt.format(date)}`;
                document.getElementById('temp').appendChild(div);
            }
        }
        
        onGetLastTemperatures = function(count, timestamps, thermometer_ids, measurements){
            
            for(let i=0; i<count; i++){
                thermometers[ thermometer_ids[i] ] = {
                    time: timestamps[i],
                    value: measurements[i],
                    id: thermometer_ids[i]
                };
            }
            reloadTemps();
        }
        
        // To automatycznie zaktualizuje tablice z nazwami, która wykożystywana jest przez 'getDeviceNameById', który wywoływany jest w 'reloadTemps'
        onGetThermometerNames = function(){ 
            reloadTemps();
        }
        
        
        // To poniżęj jest tylko i wyłącznie dla testów
        setTimeout(() => {
            socket.sendGetThermometerNames();
        }, 2000);
        setTimeout(() => {
            socket.sendGetLatestTemperatures();
        }, 3000);
        
        // Tą funkcję wywołać można ręcznie w konsolce
        function generate_test_thermometers_output(){
            RecognizedDeviceNames["111111111111"] = "Piętro 1";
            RecognizedDeviceNames["222222222222"] = "Piętro 2 Kuchnia";
            RecognizedDeviceNames["333333333333"] = "Piętro 2 Łazienka";
            
            // Zasymulowanie otrzymania odpowiedzi od serwera z randomowymi danymi
            // Można se dodać jakieś inne dane jak chcesz
            let now = new Date().getTime();
            onGetLastTemperatures(4,
                [now, now-1000, now-2000, now-3000],
                [111111111111, 222222222222, 333333333333, 12092432184172583680],
                [12, -32.5, 100, 54.32]
            );
        }


    </script>

</body>
</html>